from brython_robot4 import init, load_scene_from_url, get_url_parameter
from browser import aio

# 機器人行為腳本
async def robot_actions(robot):
    print("開始執行機器人程式，使用水平掃描模式採收所有胡蘿蔔。")

    # --- 輔助函式 ---

    async def turn_right():
        """向右轉 90 度"""
        await robot.turn_left()
        await robot.turn_left()
        await robot.turn_left()

    async def collect_in_current_square():
        """在當前格子採收所有胡蘿蔔"""
        while robot.background_is("pale_grass"):
            await robot.pick_carrot()

    # --- 主要採收邏輯 ---

    # 1. 將機器人定位到起始點 (0, 0)
    # 假設機器人初始方向為右或上，先嘗試向左走到底（Y=0），再向上走到底（X=0）。
    # (如果初始位置不確定，可能需要更精確的定位，但在此假設從某個角落開始)
    
    # 2. 開始水平採收迴圈
    
    # 獲取世界的高度 (行數) 和寬度 (列數)
    world_height = robot.world.height
    world_width = robot.world.width
    
    # 標記當前行的行進方向 (True=向右/東, False=向左/西)
    moving_right = True

    # 確保從最左邊開始 (X=0)
    # 假設初始位置在 (0, 0) 附近，如果不在，則需要移動到 (0, 0)
    while robot.base.x > 0:
        await robot.turn_left() # 面向左 (西)
        await robot.move(1)
    await turn_right() # 面向南/下
    while robot.base.y > 0:
        await robot.move(1)
    await robot.turn_left() # 轉向東 (右)，準備開始採收

    # 從 Y=0 (最底部行) 開始掃描
    for row in range(world_height):
        
        # A. 在行首採集
        await collect_in_current_square()

        # B. 沿著當前行掃描
        # world_width - 1 是因為起始格子已經算在內
        for _ in range(world_width - 1):
            if robot.front_is_clear():
                await robot.move(1)
                await collect_in_current_square()
            else:
                 # 理論上，水平掃描不應該遇到牆壁，如果遇到，則停止本行掃描
                 break
        
        # C. 檢查是否是最後一行
        if row < world_height - 1:
            
            # 1. 轉向下一行 (垂直移動)
            if moving_right:
                await robot.turn_left() # 從右轉向上 (北)
            else:
                await turn_right()      # 從左轉向上 (北)

            # 2. 向上移動一步，進入下一行
            await robot.move(1)
            await collect_in_current_square() # 採集該行首格子

            # 3. 轉向準備採集下一行 (水平移動)
            if moving_right:
                await robot.turn_left() # 轉向左 (西)
                moving_right = False
            else:
                await turn_right()      # 轉向右 (東)
                moving_right = True

    # 所有的探索和採集動作都結束後
    print("所有可達格子都已探索完畢。")
    print(f"程式執行完畢。總共採收了 {robot.carrots_collected} 個胡蘿蔔。")

# 程式啟動點 (保持不變)
async def main():
    world_url = get_url_parameter('world')
    if world_url:
        scene_data = await load_scene_from_url(world_url)
        # 設定機器人容量上限為 50
        world, robot = init(scene_data, robot_config={"max_carrots": 50})
    else:
        # 預設場景也設定容量上限
        world, robot = init(robot_config={"max_carrots": 50})

    if robot:
        await robot_actions(robot)

# 啟動主程式 (保持不變)
aio.run(main())
